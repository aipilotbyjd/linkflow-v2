name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  GO_VERSION: '1.23'

jobs:
  # ============================================
  # CI: Test & Build
  # ============================================
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.out

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binaries
        run: |
          CGO_ENABLED=0 GOOS=linux go build -o bin/api ./cmd/api
          CGO_ENABLED=0 GOOS=linux go build -o bin/worker ./cmd/worker
          CGO_ENABLED=0 GOOS=linux go build -o bin/scheduler ./cmd/scheduler

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: bin/

  # ============================================
  # CD: Deploy to Dev (on push to develop)
  # ============================================
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR credentials
        id: acr
        run: |
          echo "server=$(az acr show -n linkflowdevregistry --query loginServer -o tsv)" >> $GITHUB_OUTPUT
          echo "username=$(az acr credential show -n linkflowdevregistry --query username -o tsv)" >> $GITHUB_OUTPUT
          echo "password=$(az acr credential show -n linkflowdevregistry --query passwords[0].value -o tsv)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.acr.outputs.server }}
          username: ${{ steps.acr.outputs.username }}
          password: ${{ steps.acr.outputs.password }}

      - name: Build and push images
        run: |
          docker build -f Dockerfile.api -t ${{ steps.acr.outputs.server }}/linkflow-api:${{ github.sha }} .
          docker build -f Dockerfile.worker -t ${{ steps.acr.outputs.server }}/linkflow-worker:${{ github.sha }} .
          docker build -f Dockerfile.scheduler -t ${{ steps.acr.outputs.server }}/linkflow-scheduler:${{ github.sha }} .
          docker push ${{ steps.acr.outputs.server }}/linkflow-api:${{ github.sha }}
          docker push ${{ steps.acr.outputs.server }}/linkflow-worker:${{ github.sha }}
          docker push ${{ steps.acr.outputs.server }}/linkflow-scheduler:${{ github.sha }}

      - name: Deploy with Terraform
        working-directory: infra
        run: |
          terraform init -backend-config=environments/dev/backend.tfvars
          terraform apply -auto-approve \
            -var-file=environments/dev/terraform.tfvars \
            -var="image_tag=${{ github.sha }}"

  # ============================================
  # CD: Deploy to Staging (on push to main)
  # ============================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR credentials
        id: acr
        run: |
          echo "server=$(az acr show -n linkflowstagingregistry --query loginServer -o tsv)" >> $GITHUB_OUTPUT
          echo "username=$(az acr credential show -n linkflowstagingregistry --query username -o tsv)" >> $GITHUB_OUTPUT
          echo "password=$(az acr credential show -n linkflowstagingregistry --query passwords[0].value -o tsv)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.acr.outputs.server }}
          username: ${{ steps.acr.outputs.username }}
          password: ${{ steps.acr.outputs.password }}

      - name: Build and push images
        run: |
          docker build -f Dockerfile.api -t ${{ steps.acr.outputs.server }}/linkflow-api:${{ github.sha }} .
          docker build -f Dockerfile.worker -t ${{ steps.acr.outputs.server }}/linkflow-worker:${{ github.sha }} .
          docker build -f Dockerfile.scheduler -t ${{ steps.acr.outputs.server }}/linkflow-scheduler:${{ github.sha }} .
          docker push ${{ steps.acr.outputs.server }}/linkflow-api:${{ github.sha }}
          docker push ${{ steps.acr.outputs.server }}/linkflow-worker:${{ github.sha }}
          docker push ${{ steps.acr.outputs.server }}/linkflow-scheduler:${{ github.sha }}

      - name: Deploy with Terraform
        working-directory: infra
        run: |
          terraform init -backend-config=environments/staging/backend.tfvars
          terraform apply -auto-approve \
            -var-file=environments/staging/terraform.tfvars \
            -var="image_tag=${{ github.sha }}"

  # ============================================
  # CD: Deploy to Production (manual approval)
  # ============================================
  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: 
      name: prod
      url: https://linkflow-prod-api.azurecontainerapps.io
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Get ACR credentials
        id: acr
        run: |
          echo "server=$(az acr show -n linkflowprodregistry --query loginServer -o tsv)" >> $GITHUB_OUTPUT
          echo "username=$(az acr credential show -n linkflowprodregistry --query username -o tsv)" >> $GITHUB_OUTPUT
          echo "password=$(az acr credential show -n linkflowprodregistry --query passwords[0].value -o tsv)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.acr.outputs.server }}
          username: ${{ steps.acr.outputs.username }}
          password: ${{ steps.acr.outputs.password }}

      - name: Build and push images
        run: |
          docker build -f Dockerfile.api -t ${{ steps.acr.outputs.server }}/linkflow-api:${{ github.sha }} .
          docker build -f Dockerfile.worker -t ${{ steps.acr.outputs.server }}/linkflow-worker:${{ github.sha }} .
          docker build -f Dockerfile.scheduler -t ${{ steps.acr.outputs.server }}/linkflow-scheduler:${{ github.sha }} .
          docker push ${{ steps.acr.outputs.server }}/linkflow-api:${{ github.sha }}
          docker push ${{ steps.acr.outputs.server }}/linkflow-worker:${{ github.sha }}
          docker push ${{ steps.acr.outputs.server }}/linkflow-scheduler:${{ github.sha }}

      - name: Deploy with Terraform
        working-directory: infra
        run: |
          terraform init -backend-config=environments/prod/backend.tfvars
          terraform apply -auto-approve \
            -var-file=environments/prod/terraform.tfvars \
            -var="image_tag=${{ github.sha }}"

      - name: Notify deployment
        run: echo "Production deployment completed for commit ${{ github.sha }}"
